<script>
const token = localStorage.getItem("access");
if (!token) window.location.href = "/login/";
</script>

<nav>
  <a href="/admin/dashboard/">Dashboard</a> |
  <a href="/admin/orders/">Orders</a> |
  <a href="/admin/payments/">Payments</a> |
  <a href="/admin/categories/">Categories</a> |
  <a href="/login/" onclick="localStorage.clear()">Logout</a>
</nav>

<h2>Admin Products</h2>

<form id="productForm">
  <input type="hidden" id="productId">

  <label>Name</label><br>
  <input id="name" required><br><br>

  <label>SKU</label><br>
  <input id="sku" required><br><br>

  <label>Description</label><br>
  <textarea id="description" required></textarea><br><br>

  <label>Price</label><br>
  <input id="price" type="number" step="0.01" required><br><br>

  <label>Stock</label><br>
  <input id="stock" type="number" required><br><br>

  <label>Status</label><br>
  <select id="status">
    <option value="active">Active</option>
    <option value="inactive">Inactive</option>
  </select><br><br>

  <label>Category</label><br>
  <select id="categorySelect" required>
    <option value="">-- Select a Category --</option>
  </select><br><br>

  <button type="button" onclick="saveProduct()">Save</button>
</form>

<hr>
<ul id="productList"></ul>

<script>
// 1. New function to load categories into the dropdown
function loadCategoryDropdown() {
  fetch("/api/categories/", {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => res.json())
  .then(data => {
    const select = document.getElementById("categorySelect");
    // Clear existing options except the first placeholder
    select.innerHTML = '<option value="">-- Select a Category --</option>';
    
    data.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat.id;
      option.textContent = cat.name;
      select.appendChild(option);
    });
  })
  .catch(err => console.error("Error loading categories:", err));
}

function saveProduct() {
  const id = document.getElementById("productId").value;

  const payload = {
    name: document.getElementById("name").value.trim(),
    sku: document.getElementById("sku").value.trim(),
    description: document.getElementById("description").value.trim(),
    price: document.getElementById("price").value,
    stock: document.getElementById("stock").value,
    status: document.getElementById("status").value,
    // Use the value from the new select dropdown
category: document.getElementById("categorySelect").value || null
  };

  if (!payload.name || !payload.category) {
    alert("Name and Category are required");
    return;
  }

  const url = id ? `/api/products/${id}/` : `/api/products/`;
  const method = id ? "PATCH" : "POST";

  fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.ok ? res.json() : res.json().then(e => Promise.reject(e)))
  .then(() => {
    alert("Saved successfully");
    document.getElementById("productForm").reset();
    document.getElementById("productId").value = "";
    loadProducts();
  })
  .catch(err => alert("Error: " + JSON.stringify(err)));
}

function loadProducts() {
  fetch("/api/products/", {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => res.json())
  .then(data => {
    const productList = document.getElementById("productList");
    productList.innerHTML = "";
    data.forEach(p => {
      productList.innerHTML += `
        <li>
          <b>${p.name}</b> | $${p.price} | ${p.status} | Stock: ${p.stock} | 
          Category: ${p.category_name || 'None'} 
          <br>
          <button onclick='editProduct(${JSON.stringify(p)})'>Edit</button>
          <button onclick='deleteProduct(${p.id})'>Delete</button>
        </li><hr>`;
    });
  });
}

function editProduct(p) {
  document.getElementById("productId").value = p.id;
  document.getElementById("name").value = p.name;
  document.getElementById("sku").value = p.sku;
  document.getElementById("description").value = p.description;
  document.getElementById("price").value = p.price;
  document.getElementById("stock").value = p.stock;
  document.getElementById("status").value = p.status;
  // Set the dropdown to the product's current category ID
  document.getElementById("categorySelect").value = p.category || "";
}

function deleteProduct(id) {
  if (!confirm("Delete product permanently?")) return;

  fetch(`/api/products/${id}/`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  }).then(() => loadProducts());
}

// Initialize the page
loadCategoryDropdown(); 
loadProducts();
</script>