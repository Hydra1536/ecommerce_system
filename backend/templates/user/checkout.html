<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  .bkash-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .bkash-modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 400px;
    border-radius: 8px;
    text-align: center;
  }
  .bkash-logo {
    font-size: 24px;
    font-weight: bold;
    color: #e31b54;
    margin-bottom: 20px;
  }
  .payment-amount {
    font-size: 18px;
    margin: 20px 0;
  }
  .pay-button {
    background-color: #e31b54;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px;
  }
  .cancel-button {
    background-color: #666;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px;
  }
</style>

<script>
  const token = localStorage.getItem("access");

  if (!token && !location.pathname.includes("login") && !location.pathname.includes("register")) {
    window.location.href = "/login/";
  }
</script>

<nav>
  <a href="/products/">Products</a> |
  <a href="/cart/">Cart</a> |
  <a href="/orders/">Orders</a> |
  {% comment %} <a href="/admin/dashboard/">Admin</a> | {% endcomment %}
  <a href="/login/" onclick="localStorage.clear()">Logout</a>
</nav>
<hr>

<h2>Checkout</h2>
<ul id="summary"></ul>

<button onclick="pay('stripe')">Stripe</button>
<button id="bKash_button" disabled onclick="pay('bkash')">Pay with bKash</button>

<!-- bKash Demo Modal -->
<div id="bkashModal" class="bkash-modal">
  <div class="bkash-modal-content">
    <div class="bkash-logo">bKash Payment</div>
    <div class="payment-amount">Amount: BDT <span id="modalAmount"></span></div>
    <p>Demo Payment - Click Pay to simulate successful payment</p>
    <button class="pay-button" onclick="simulatePayment()">Pay Now</button>
    <button class="cancel-button" onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const summary = document.getElementById("summary");

  if (cart.length === 0) {
    summary.innerHTML = "<li>No items in cart</li>";
  }

  cart.forEach(i => {
    summary.innerHTML += `<li>Product ${i.product_id} x ${i.quantity}</li>`;
  });

  let currentOrder = null;

  function pay(provider) {
    fetch("/api/orders/create/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("access")
      },
      body: JSON.stringify({ items: cart })
    })
      .then(res => {
        if (!res.ok) throw new Error("Order failed");
        return res.json();
      })
      .then(order => {
        currentOrder = order;
        return fetch(`/api/payments/pay/${order.id}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("access")
          },
          body: JSON.stringify({ provider })
        });
      })
      .then(res => res.json())
      .then(data => {
        localStorage.removeItem("cart");
        if (provider === "stripe") {
          window.location.href = data;
        }
        else if (provider === "bkash") {
          initBkash(data.amount, currentOrder.id);
        }
        else {
          alert("Payment initiated");
          window.location.href = "/orders/";
        }
      })
      .catch(err => alert(err.message));
  }

  let currentPaymentId = null;

  function initBkash(amount, orderId) {
    // Show demo modal
    document.getElementById('modalAmount').textContent = amount;
    document.getElementById('bkashModal').style.display = 'block';

    // Simulate create request
    fetch("/api/payments/bkash/create/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("access")
      },
      body: JSON.stringify({
        order_id: orderId,
        amount: amount
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.paymentID) {
          currentPaymentId = data.paymentID;
        } else {
          alert("Payment creation failed");
          closeModal();
        }
      })
      .catch(err => {
        console.error(err);
        alert("Payment creation failed");
        closeModal();
      });
  }

  function simulatePayment() {
    // Simulate successful payment
    fetch("/api/payments/bkash/execute/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("access")
      },
      body: JSON.stringify({
        paymentID: currentPaymentId
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.transactionStatus === "Completed") {
          closeModal();
          window.location.href = "/orders/";
        } else {
          alert("Payment failed");
          closeModal();
        }
      })
      .catch(err => {
        console.error(err);
        alert("Payment failed");
        closeModal();
      });
  }

  function closeModal() {
    document.getElementById('bkashModal').style.display = 'none';
  }

  // Enable bKash button on page load
  $(document).ready(function() {
    $('#bKash_button').removeAttr('disabled');
  });
</script>

