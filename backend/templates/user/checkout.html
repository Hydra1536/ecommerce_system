<script>
  const token = localStorage.getItem("access");

  if (!token && !location.pathname.includes("login") && !location.pathname.includes("register")) {
    window.location.href = "/login/";
  }
</script>

<nav>
  <a href="/products/">Products</a> |
  <a href="/cart/">Cart</a> |
  <a href="/orders/">Orders</a> |
  {% comment %} <a href="/admin/dashboard/">Admin</a> | {% endcomment %}
  <a href="/login/" onclick="localStorage.clear()">Logout</a>
</nav>
<hr>

<h2>Checkout</h2>
<ul id="summary"></ul>

<button onclick="pay('stripe')">Stripe</button>
<button onclick="pay('bkash')">bKash</button>

<script>
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const summary = document.getElementById("summary");

  if (cart.length === 0) {
    summary.innerHTML = "<li>No items in cart</li>";
  }

  cart.forEach(i => {
    summary.innerHTML += `<li>Product ${i.product_id} x ${i.quantity}</li>`;
  });

  function pay(provider) {
    fetch("/api/orders/create/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("access")
      },
      body: JSON.stringify({ items: cart })
    })
      .then(res => {
        if (!res.ok) throw new Error("Order failed");
        return res.json();
      })
      .then(order => {
        return fetch(`/api/payments/pay/${order.id}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("access")
          },
          body: JSON.stringify({ provider })
        });
      })
      .then(() => {
        localStorage.removeItem("cart");
        alert("Payment initiated");
        window.location.href = "/orders/";
      })
      .catch(err => alert(err.message));
  }
</script>

